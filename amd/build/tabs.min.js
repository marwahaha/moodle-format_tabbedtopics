define(["jquery","jqueryui"],function(a){return{init:function(){var b=function(b,c){console.log("single section in tab: using section name as tab name");var d=c.find(".sectionname:not(.hidden)");if(a(".tabname_backup:visible").length>-1){var e=c.attr("aria-label");b.parent().append(b.clone().addClass("tabname_backup").hide()),b.html(e).addClass("tabsectionname"),0===a(".inplaceeditable").length?(d.hide(),c.find(".sectionhead").hide()):(d.addClass("edit_only"),c.find(".hidden.sectionname").hide(),c.find(".section-handle").hide())}};a(".section").on("updated",function(){var b=a(this).find(".inplaceeditable").attr("data-value");a(this).attr("aria-label",b),a(".tablink.active").click()}),a(".sectionnamexxx").on("updated",function(){var b=a(this).find(".inplaceeditable").attr("data-value");a(".hidden.sectionname").html(b),a(".tablink.active").click()});var c=function(b){var c=b.parent().find(".tabname_backup"),d=b.parent().find(".tabsectionname").removeClass("tabsectionname");d.html(c.html()),c.remove(),a(".sectionname").removeClass("edit_only"),a(".sectionname").show(),a(".hidden.sectionname").show(),a(".section-handle").show(),console.log("--> restoring section headline ")},d=function(){a(".tablink").on("click",function(){var d=a(this).attr("id"),e=a(this).attr("sections"),f=e.split(",");console.log("----"),a(".active").removeClass("active"),a(this).addClass("active");var g;a(this).find(".inplaceeditable-text")&&(g=a(this).find(".inplaceeditable-text").attr("data-value")),"undefined"==typeof g&&(g=a(this).html()),console.log('Clicked tab "'+g+'":'),"tab0"===d?(a("#changenumsections").show(),a("li.section").show(),a(".topictab:visible").each(function(){a(this).attr("sections").length>0&&a.each(a(this).attr("sections").split(","),function(b,c){var d=a(".section[section-id='"+c+"']");d.hide(),console.log("--> hiding section "+c)})})):(a("#changenumsections").show(),a("li.section").hide(),a.each(f,function(b,c){var d=a(".section[section-id='"+c+"']");d.show(),console.log("--> showing section "+c)})),a("#ontop_area #section-0").show();var h=a("li.section:visible").length,i=a("li.section.hidden:visible").length;if(a(".section0_ontop").length>0&&(console.log("section0 is on top - so reducing the number of visible sections for this tab by 1"),h--),console.log("number of visible sections: "+h),console.log("number of hidden sections: "+i),h<=i){a(this).addClass("tab-not-shown"),console.log("==> marking hidden tab "+d);var j=a(this);require(["core/str"],function(b){var c=b.get_string("hidden_tab_hint","format_tabtopics");a.when(c).done(function(a){j.find("#not-shown-hint-"+d).remove(),j.append('<i id="not-shown-hint-'+d+'" class="fa fa-info" title="'+a+'"></i>')})})}else a(this).removeClass("tab-not-shown"),a("#not-shown-hint-"+d).remove();if(h<1?(console.log("tab with no visible sections - hiding it"),a(this).parent().hide()):(console.log("tab with visible sections - showing it"),a(this).parent().show()),a(".single_section_tabs").length>0&&"tab0"!==d){var k=a("li.section:visible:not(.hidden)").first();a(".section0_ontop").length>0&&(k=a("li.section:visible:not(.hidden):eq(1)"));var l=k.attr("id");h-i<=1&&"section-0"!=l?b(a(this),k):a(".inplaceeditable").length>0&&"section-0"!=l&&c(a(this))}"tab0"===d&&1===a(".tabitem:visible").length&&(console.log("--> tab0 is a single tab - hiding it"),a(".tabitem").hide())})},e=function(){a(".tab_mover").on("click",function(){var b=a(this).attr("tabnr"),d=a(this).closest("li.section").attr("section-id"),e=a(this).closest("li.section").attr("id").substring(8);console.log("--> found section num: "+e);var f=a(".topictab.active").first().attr("id");"undefined"==typeof f&&(f="tab0"),console.log("----"),console.log("moving section "+d+' from tab "'+f+'" to tab nr '+b),a(".tablink").each(function(){a(this).attr("sections",a(this).attr("sections").replace(","+d,"")),a(this).attr("sections",a(this).attr("sections").replace(d+",","")),a(this).attr("sections",a(this).attr("sections").replace(d,"")),a(this).attr("section_nums",a(this).attr("section_nums").replace(","+e,"")),a(this).attr("section_nums",a(this).attr("section_nums").replace(e+",","")),a(this).attr("section_nums",a(this).attr("section_nums").replace(e,""))}),b>0&&(0===a("#tab"+b).attr("sections").length?a("#tab"+b).attr("sections",a("#tab"+b).attr("sections")+d):a("#tab"+b).attr("sections",a("#tab"+b).attr("sections")+","+d),0===a("#tab"+b).attr("section_nums").length?a("#tab"+b).attr("section_nums",a("#tab"+b).attr("section_nums")+e):(a("#tab"+b).attr("section_nums",a("#tab"+b).attr("section_nums")+","+e),console.log("---> section_nums: "+a("#tab"+b).attr("section_nums")))),a("#tab"+b).click(),a("#"+f).click(),c(a("#tab"+b));var g=a(".topictab:visible").length;console.log("visible tabs: "+g);var h=a("li.section:visible").length-(a("#ontop_area").hasClass("section0_ontop")?1:0);console.log("---> visible sections = "+a("li.section:visible").length),console.log("---> countable_sections = "+h),h>0&&a("li.section:visible").length>=h?(console.log("staying with the current tab (id = "+f+") as there are still "+a("li.section:visible").length+" sections left"),a("#tab"+b).click(),a("#"+f).click()):(console.log("no section in active tab id "+f+" left - hiding it and following section to new tab nr "+b),a("#tab"+b).click(),a("#"+f).parent().hide())})},f=function(){a(".ontop_mover").on("click",function(){a("#ontop_area").append(a(this).closest(".section")),a("#ontop_area").addClass("section0_ontop")})},g=function(){a(".inline_mover").on("click",function(){var b=a(this).closest(".section").attr("section-id");a("#inline_area").append(a(this).closest(".section")),a(".section0_ontop").removeClass("section0_ontop"),a(".tablink").each(function(){if(a(this).attr("sections").indexOf(b)>-1)return a(this).click(),!1})})},h=function(){a(".menubar").on("click",function(){var b=a(this).closest(".section").attr("id");a("#"+b+" .tab_mover").show();var c=[],d=[];if(a(".tablink").each(function(){var b="",e=a(this).attr("tab_title"),f=a(this).attr("id").substr(3);b=a(this).hasClass("tabsectionname")?a(this).html():a(this).attr("tab_title"),a.inArray(e,d)<0&&(c[f]=b,d.push(e))}),console.log("--> Updating menu options with current tab names"),a(this).parent().find(".tab_mover").each(function(){var b=a(this).attr("tabnr"),d=a(this).find(".menu-action-text").html();console.log(b+" --> "+d+" ==> "+c[b]),a(this).find(".menu-action-text").html('To Tab "'+c[b]+'"')}),"section-0"===b)1===a("#ontop_area.section0_ontop").length?(a("#section-0 .inline_mover").show(),a("#section-0 .tab_mover").addClass("tab_mover_bak").removeClass("tab_mover").hide(),a("#section-0 .ontop_mover").hide()):(a("#section-0 .inline_mover").hide(),a("#section-0 .tab_mover_bak").addClass("tab_mover").removeClass("tab_mover_bak").show(),a("#section-0 .ontop_mover").show());else if("undefined"!=typeof a(".tablink.active").attr("id")){var e=a(".tablink.active").attr("id").substring(3);a("#"+b+' .tab_mover[tabnr="'+e+'"]').hide(),console.log("hiding tab "+e+" from edit menu for section "+b)}})},i=function(){d(),e(),f(),g(),h()},j=function(b,c){var d=c.draggable.find(".topictab").first(),e=a(this).find(".topictab").first(),f=c.draggable.find(".topictab").first().attr("id"),g=a(this).find(".topictab").first().attr("id");console.log('The tab with ID "'+f+'" was dropped onto tab with the ID "'+g+'"');var h=d.parent().html();d.parent().html(e.parent().html()),e.parent().html(h),i();var j="";a(".tablink").each(function(){var b=a(this).attr("id");"undefined"!=typeof b&&(""===j?j=b:j.indexOf(b)===-1&&(j=j.concat(",").concat(b)))});var k=a(".topictab:visible").first().attr("sections").split(",")[0];"block_assessment_information"===k&&(k=a(".topictab:visible:eq(1)").attr("sections").split(",")[0]),a.ajax({url:"format/tabtopics/ajax/update_tab_seq.php",type:"POST",data:{sectionid:k,tab_seq:j},success:function(a){console.log("the new tab sequence: "+a)}})};a("a").click(function(){if("#"!==a(this).attr("href")){var b=a(this).attr("href").split("#")[1];if("undefined"!=typeof b){var c=a("#"+b).attr("section-id"),d=!1;a(".tablink").each(function(){if(a(this).attr("sections").indexOf(c)>-1)return a(this).click(),d=!0,!1}),d||a("#tab0").click()}}}),a(document).ready(function(){i(),0===a(".section0_ontop").length&&a("#section-0 .right.side").show(),a(".inplaceeditable").length>0&&(a(".topictab").parent().draggable({cursor:"move",stack:".tabitem",revert:!0}),a(".topictab").parent().droppable({accept:".tabitem",hoverClass:"hovered",drop:j})),a(".topictab:visible").length>0&&(a("#tab0").click(),a(".tablink:visible").click(),a(".tablink:visible").first().click()),a("#ontop_area").hasClass("section0_ontop")?(a("#section-0 .inline_mover").show(),a("#section-0 .tab_mover").hide(),a("#section-0 .ontop_mover").hide()):(a("#section-0 .inline_mover").hide(),a("#section-0 .tab_mover").show(),a("#section-0 .ontop_mover").show())})}}});